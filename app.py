import os
import calendar
from datetime import datetime
from PIL import Image

import pandas as pd
import streamlit as st

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Path Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = os.path.join(BASE_DIR, "data")
IMG_DIR  = os.path.join(BASE_DIR, "images")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Mom's Totem Guide (åª½åª½æ¯æ—¥ç”Ÿå­˜æ³•å‰‡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mom_totem_guide = {
    # ğŸ”´ ç´…è‰²å®¶æ—ï¼šèº«é«”èˆ‡ç”Ÿå­˜
    "ç´…é¾": {
        "theme": "èº«é«”èˆ‡ç”Ÿå­˜ (ç…§é¡§è‚‰èº«)",
        "avoid": "é¤“è‚šå­ã€çŠ§ç‰²è‡ªå·±æŠŠå¤§å®¶éƒ½é¤µé£½äº†æ‰åƒé£¯ã€‚",
        "charge": "å…ˆæˆ´ä¸Šæ°§æ°£ç½©ã€‚å¥½å¥½åƒé “å–œæ­¡çš„æ—©é¤ï¼ŒæŠŠè‡ªå·±æ»‹é¤Šå¥½ã€‚"
    },
    "ç´…è›‡": {
        "theme": "èº«é«”èˆ‡ç”Ÿå­˜ (ç…§é¡§è‚‰èº«)",
        "avoid": "å¿½è¦–èº«é«”ç— ç—›ã€ç–²ç´¯æ™‚é‚„ç¡¬æ’åšå®¶äº‹ã€‚",
        "charge": "éš¨æ™‚èººå¹³ã€‚è·Ÿå­©å­ä¸€èµ·åˆç¡ï¼Œåšç‘œçˆä¼¸å±•ï¼Œå»æŒ‰æ‘©ã€‚"
    },
    "ç´…æœˆ": {
        "theme": "èº«é«”èˆ‡ç”Ÿå­˜ (ç…§é¡§è‚‰èº«)",
        "avoid": "å¿ä½çœ¼æ·šã€å¼·é¡æ­¡ç¬‘ã€å°æƒ…ç·’éåº¦åæ‡‰ã€‚",
        "charge": "åƒæ°´ä¸€æ¨£æµå‹•ã€‚å¤šå–æ°´ã€æ³¡æ¾¡ã€å…è¨±è‡ªå·±å“­ä¸€å ´æ’æ¯’ã€‚"
    },
    "ç´…å¤©è¡Œè€…": {
        "theme": "èº«é«”èˆ‡ç”Ÿå­˜ (ç…§é¡§è‚‰èº«)",
        "avoid": "æ•´å¤©é—œåœ¨å®¶å°è‘—ç‰†å£ã€ä¸€æˆä¸è®Šã€‚",
        "charge": "æ¨æ¨è»Šå‡ºå»èµ°èµ°ã€‚å»æ²’å»éçš„å…¬åœ’ï¼Œè½‰æ›ç©ºé–“é€é€æ°£ã€‚"
    },
    "ç´…åœ°çƒ": {
        "theme": "èº«é«”èˆ‡ç”Ÿå­˜ (ç…§é¡§è‚‰èº«)",
        "avoid": "è¶•æ™‚é–“ã€å‚¬å­©å­å¿«ä¸€é»ã€ç„¦æ…®é€²åº¦ã€‚",
        "charge": "èµ¤è…³æ¥åœ°ã€‚å»å¤§è‡ªç„¶é‡é¤ï¼Œé—œæ‰å°èˆªï¼Œæ…¢å°±æ˜¯å¿«ã€‚"
    },
    # âšª åŒ—æ–¹ç™½è‰²å®¶æ—ï¼šå¿ƒæ™ºèˆ‡æ·¨åŒ–
    "ç™½é¢¨": {
        "theme": "å¿ƒæ™ºèˆ‡æ·¨åŒ– (æ¸…ç†å¿ƒéˆ)",
        "avoid": "ç¢ç¢å”¸ã€å¼å«ã€èªè¨€æš´åŠ›ã€‚",
        "charge": "æ·±å‘¼å¸èˆ‡è¬›æ•…äº‹ã€‚èªªè©±å‰å…ˆæ·±å‘¼å¸ä¸‰æ¬¡ï¼Œæ”¾å¥½è½çš„éŸ³æ¨‚ã€‚"
    },
    "ç™½ä¸–ç•Œæ©‹": {
        "theme": "å¿ƒæ™ºèˆ‡æ·¨åŒ– (æ¸…ç†å¿ƒéˆ)",
        "avoid": "ä»€éº¼éƒ½æƒ³æ§åˆ¶ã€æ¨ä¸å¾—ä¸ŸèˆŠç©å…·ã€‚",
        "charge": "æ–·æ¨é›¢ã€‚ä¸Ÿæ‰å£æ‰çš„æ±è¥¿ï¼Œæ”¾æ‰‹è®“éšŠå‹å»é¡§å°å­©ã€‚"
    },
    "ç™½ç‹—": {
        "theme": "å¿ƒæ™ºèˆ‡æ·¨åŒ– (æ¸…ç†å¿ƒéˆ)",
        "avoid": "è¨å¥½å©†å®¶æˆ–å¤–äººã€å§”å±ˆè‡ªå·±ã€æƒ…ç·’å‹’ç´¢ã€‚",
        "charge": "æ“æŠ±ç™‚æ³•ã€‚æŠ±ç·Šå­©å­æˆ–ä¼´ä¾¶è¶…é20ç§’ï¼Œæ‰¾å›æ„›çš„æ„Ÿè¦ºã€‚"
    },
    "ç™½å·«å¸«": {
        "theme": "å¿ƒæ™ºèˆ‡æ·¨åŒ– (æ¸…ç†å¿ƒéˆ)",
        "avoid": "ä¸€ç›´çœ‹æ™‚é˜ç„¦æ…®ã€Œä¾†ä¸åŠäº†ã€ã€æ“”æ†‚æœªä¾†ã€‚",
        "charge": "é–‰çœ¼å……é›»ã€‚è¶å­©å­ç©æ™‚é–‰ç›®é¤Šç¥5åˆ†é˜ï¼Œç›¸ä¿¡ä¸€åˆ‡è‡ªæœ‰å®‰æ’ã€‚"
    },
    "ç™½é¡": {
        "theme": "å¿ƒæ™ºèˆ‡æ·¨åŒ– (æ¸…ç†å¿ƒéˆ)",
        "avoid": "ç…§é¡å­æŒ‘å‰”èº«æã€æ‰¹åˆ¤å­©å­çš„è¡Œç‚ºã€‚",
        "charge": "ç¨±è®šç·´ç¿’ã€‚å°é¡ä¸­çš„è‡ªå·±èªªã€Œå¦³åšå¾—å¾ˆå¥½ã€ï¼Œçœ‹è¦‹è¡Œç‚ºèƒŒå¾Œçš„éœ€æ±‚ã€‚"
    },
    # ğŸ”µ è¥¿æ–¹è—è‰²å®¶æ—ï¼šæƒ…ç·’èˆ‡éŠæˆ²
    "è—å¤œ": {
        "theme": "æƒ…ç·’èˆ‡éŠæˆ² (æ‰¾å›ç«¥å¿ƒ)",
        "avoid": "ç‚ºäº†å®¶ç”¨é–‹éŠ·ç„¦æ…®ã€å–Šçª®ã€æ„Ÿåˆ°åŒ±ä¹ã€‚",
        "charge": "ç™½æ—¥å¤¢æ™‚é–“ã€‚è·Ÿå­©å­ä¸€èµ·å¹»æƒ³é­”æ³•ä¸–ç•Œï¼Œå®‰å¿ƒç¡å€‹å¥½è¦ºã€‚"
    },
    "è—æ‰‹": {
        "theme": "æƒ…ç·’èˆ‡éŠæˆ² (æ‰¾å›ç«¥å¿ƒ)",
        "avoid": "åªå‹•å˜´ä¸å‹•æ‰‹ï¼ˆè¶Šæƒ³è¶Šç…©ï¼‰ã€æ‡¶å¾—å‹•ã€‚",
        "charge": "æ‰‹ä½œç™‚ç™’ã€‚ç©é»åœŸã€ç•«ç•«ã€çƒ˜ç„™ï¼Œå°ˆæ³¨åœ¨å‹•æ‰‹åšçš„ç•¶ä¸‹ã€‚"
    },
    "è—çŒ´": {
        "theme": "æƒ…ç·’èˆ‡éŠæˆ² (æ‰¾å›ç«¥å¿ƒ)",
        "avoid": "å¤ªåš´è‚…ã€è·Ÿå­©å­è¬›å¤§é“ç†ã€ç»ç’ƒå¿ƒã€‚",
        "charge": "ç•¶å€‹å‚»ç“œåª½åª½ã€‚æ‰®é¬¼è‡‰ã€äº‚è·³èˆï¼Œç”¨å¹½é»˜æ„ŸåŒ–è§£åƒµå±€ã€‚"
    },
    "è—é·¹": {
        "theme": "æƒ…ç·’èˆ‡éŠæˆ² (æ‰¾å›ç«¥å¿ƒ)",
        "avoid": "ç³¾çµåœ°æ¿ä¸Šçš„é£¯ç²’æˆ–é«’è¥ªå­ã€å¾®è§€ç®¡ç†ã€‚",
        "charge": "é£›é«˜ä¸€é»çœ‹ã€‚è¦åŠƒæ—…è¡Œé¡˜æ™¯ï¼Œæƒ³è‘—å­©å­é•·å¤§çš„æ¨£å­ï¼Œæ”¾éå°ç´°ç¯€ã€‚"
    },
    "è—é¢¨æš´": {
        "theme": "æƒ…ç·’èˆ‡éŠæˆ² (æ‰¾å›ç«¥å¿ƒ)",
        "avoid": "æŠ—æ‹’æ··äº‚ã€æƒ…ç·’çˆ†ç‚¸ã€è·Ÿå­©å­ç¡¬ç¢°ç¡¬ã€‚",
        "charge": "é¢¨æš´ä¸­å¿ƒçš„å¯§éœã€‚å®¶è£¡äº‚å°±è®“å®ƒäº‚ï¼Œæ”¾æ­Œäº‚è·³ç™¼æ´©ç²¾åŠ›ã€‚"
    },
    # ğŸŸ¡ å—æ–¹é»ƒè‰²å®¶æ—ï¼šç”Ÿæ´»èˆ‡æ™ºæ…§
    "é»ƒç¨®å­": {
        "theme": "ç”Ÿæ´»èˆ‡æ™ºæ…§ (å±•ç¾å…‰èŠ’)",
        "avoid": "æ è‹—åŠ©é•·ã€æ‹¿å­©å­è·Ÿåˆ¥äººæ¯”è¼ƒã€æ€¥èºã€‚",
        "charge": "è€å¿ƒåœ’ä¸ã€‚å°è‡ªå·±å–Šè©±ã€Œæ…¢æ…¢ä¾†ã€ï¼Œè§€å¯Ÿå­©å­çš„å„ªé»ã€‚"
    },
    "é»ƒæ˜Ÿæ˜Ÿ": {
        "theme": "ç”Ÿæ´»èˆ‡æ™ºæ…§ (å±•ç¾å…‰èŠ’)",
        "avoid": "ç©¿è‘—é‚‹é¢ç¡è¡£éä¸€å¤©ã€ç’°å¢ƒé«’äº‚ã€‚",
        "charge": "æ¼‚äº®åª½å’ªæ—¥ã€‚åŒ–å¦ã€ç©¿æ¼‚äº®è¡£æœï¼Œæ•´ç†å®¶è£¡æ’æŸèŠ±ã€‚"
    },
    "é»ƒäºº": {
        "theme": "ç”Ÿæ´»èˆ‡æ™ºæ…§ (å±•ç¾å…‰èŠ’)",
        "avoid": "å„ªæŸ”å¯¡æ–·ã€æŠŠæ±ºå®šæ¬Šä¸Ÿçµ¦åˆ¥äººã€‚",
        "charge": "å°Šé‡é¸æ“‡ã€‚è®“å­©å­æ±ºå®šå°äº‹ï¼Œçµ¦è‡ªå·±ä¸€æ¯å’–å•¡çš„æ™‚é–“æ¸…é†’æ±ºç­–ã€‚"
    },
    "é»ƒæˆ°å£«": {
        "theme": "ç”Ÿæ´»èˆ‡æ™ºæ…§ (å±•ç¾å…‰èŠ’)",
        "avoid": "è·Ÿå®¶äººçˆ­è¼¸è´ã€å› å®³æ€•è€Œä¸æ•¢æ•™é¤Šã€‚",
        "charge": "æ™ºå–ä¸åŠ›æ•µã€‚é‡åˆ°é›£é¡ŒæŸ¥è³‡æ–™ï¼Œå‹‡æ•¢é¢å°é€ƒé¿å·²ä¹…çš„å®¶äº‹ã€‚"
    },
    "é»ƒå¤ªé™½": {
        "theme": "ç”Ÿæ´»èˆ‡æ™ºæ…§ (å±•ç¾å…‰èŠ’)",
        "avoid": "æŠ±æ€¨ã€ç•¶æ‚²æƒ…å¥³ä¸»è§’ã€æ•£ç™¼è² èƒ½é‡ã€‚",
        "charge": "ç™¼å…‰ç™¼ç†±ã€‚ç„¡æ¢ä»¶è®šç¾å­©å­ï¼Œå»æ›¬å¤ªé™½ï¼Œå¤§æ–¹æ¥å—è®šç¾ã€‚"
    }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Mom's Tone Guide (æ•™é¤Šèª¿ç¯€é–¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mom_tone_guide = {
    1:  {"name": "ç£æ€§", "avoid": "ä¸€å¿ƒå¤šç”¨ï¼ˆé‚Šæ»‘æ‰‹æ©Ÿé‚Šé¡§å°å­©ï¼‰ã€‚", "charge": "ç¨è™•å……é›»ã€‚çµ¦è‡ªå·±10åˆ†é˜å®Œå…¨å®‰éœçš„æ™‚é–“ã€‚"},
    2:  {"name": "æœˆäº®", "avoid": "é»‘ç™½è‡‰å¤§æˆ°ï¼ˆå¤«å¦»æ•™é¤Šä¸åŒèª¿ï¼‰ã€‚", "charge": "æ“æŠ±æŒ‘æˆ°ã€‚æ¥å—çªç™¼ç‹€æ³ï¼Œä¿æŒå½ˆæ€§ã€‚"},
    3:  {"name": "é›»åŠ›", "avoid": "å­¤è»å¥®æˆ°ã€‚", "charge": "æ‰¾å¾Œæ´ã€‚ç´„æœ‹å‹å¸¶å°å­©ä¸€èµ·ç© (Playdate)ï¼Œäº’ç›¸æ”¯æ´ã€‚"},
    4:  {"name": "è‡ªæˆ‘å­˜åœ¨", "avoid": "ç”Ÿæ´»å¤±åºã€ä½œæ¯å¤§äº‚ã€‚", "charge": "å»ºç«‹è¦çŸ©ã€‚å®šä¸‹å®¶è¦ã€æ•´ç†ç©å…·æ«ƒï¼Œå»ºç«‹SOPã€‚"},
    5:  {"name": "è¶…é »", "avoid": "å±•ç¾è‡ªå‘æˆ–ç„¡åŠ›æ„Ÿã€‚", "charge": "éšŠé•·é¢¨ç¯„ã€‚ç”±å¦³ä¸»å°è¡Œç¨‹ï¼Œå±•ç¾è‡ªä¿¡é ˜å°åŠ›ã€‚"},
    6:  {"name": "éŸ»å¾‹", "avoid": "å¿™å¾—åƒé™€èºã€å¤±å»å¹³è¡¡ã€‚", "charge": "å°‹æ±‚åˆ†å·¥ã€‚å®¶äº‹åˆ†æ”¤å‡ºå»ï¼Œè¿½æ±‚å‹•æ…‹å¹³è¡¡ã€‚"},
    7:  {"name": "å…±æŒ¯", "avoid": "å¾…åœ¨åµé›œå¿ƒç…©çš„åœ°æ–¹ã€‚", "charge": "èª¿æ•´é »é“ã€‚è®“è‡ªå·±å†·éœå†¥æƒ³ã€‚å¦³å¹³éœï¼Œå­©å­å°±å¹³éœã€‚"},
    8:  {"name": "éŠ€æ²³", "avoid": "è¨€è¡Œä¸ä¸€ï¼ˆè‡ªå·±åšä¸åˆ°å»è¦æ±‚å­©å­ï¼‰ã€‚", "charge": "èº«æ•™é‡æ–¼è¨€æ•™ã€‚æ´»å‡ºå¦³å¸Œæœ›å­©å­æˆç‚ºçš„æ¨£å­ã€‚"},
    9:  {"name": "å¤ªé™½", "avoid": "æ‡¶æ•£ã€æƒ³åšä¸åšã€‚", "charge": "è¡Œå‹•æ—¥ã€‚æƒ³å»å“ªç›´æ¥å‡ºç™¼ï¼Œé©åˆæˆ¶å¤–æ”¾é›»ã€‚"},
    10: {"name": "è¡Œæ˜Ÿ", "avoid": "è¦æ±‚å®Œç¾ã€å°çµæœä¸æ»¿æ„ã€‚", "charge": "å®Œæˆæ¸…å–®ã€‚å°ˆæ³¨æŠŠä¸€ä»¶äº‹åšå¥½ï¼Œäº«å—å®Œæˆçš„æˆå°±æ„Ÿã€‚"},
    11: {"name": "å…‰è­œ", "avoid": "å›¤ç©åƒåœ¾ã€ç”Ÿæ‚¶æ°£ã€‚", "charge": "å¤§å¼é‡‹æ”¾ã€‚å°æ•é ­å¤§å«ã€å»ç©ºæ› è™•å°–å«ï¼Œé‡‹æ”¾é‡æ“”ã€‚"},
    12: {"name": "æ°´æ™¶", "avoid": "ä¸€å€‹äººæ‚¶è‘—é ­åšã€‚", "charge": "å®¶åº­æœƒè­°ã€‚è¨è«–é€±æœ«è¨ˆç•«ï¼Œè®“å­©å­åƒèˆ‡è¨è«–ã€‚"},
    13: {"name": "å®‡å®™", "avoid": "é–‹å§‹è‰±é›£çš„æ–°è¨“ç·´ï¼ˆå¦‚æˆ’å°¿å¸ƒï¼‰ã€‚", "charge": "æ…¶ç¥èˆ‡ä¼‘æ¯ã€‚äº«å—ç•¶ä¸‹ï¼Œæ…¶ç¥å¹³å®‰åº¦éä¸€å¤©ã€‚"}
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Page Config & CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="æ˜Ÿéš›åª½åª½èƒ½é‡é¿é›·é‡", layout="wide", page_icon="ğŸ”‹")
st.markdown(
    """<style>
    /* æº«æš–çš„è‰²èª¿é©åˆåª½åª½ */
    .hero {padding:2rem 2rem; text-align:center; background: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%); border-radius: 15px; margin-bottom: 2rem; color: white;}
    .hero h1 {font-size:2.5rem; font-weight:700; margin-bottom:0.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);}
    .hero p  {font-size:1.2rem; font-weight: 500;}
    
    .footer {position:fixed; bottom:0; width:100%; background:#FFF0F5; color:#555; text-align:center; padding:1rem; z-index:999; border-top: 1px solid #ddd;}
    
    div[data-testid="stContainer"] {
        background-color: #ffffff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid #fefefe;
    }
    
    /* é¿é›·é‡å¡ç‰‡æ¨£å¼ */
    .avoid-box {
        background-color: #FFF5F5;
        border-left: 5px solid #E53E3E;
        padding: 15px;
        border-radius: 8px;
        color: #C53030;
        margin-bottom: 10px;
    }
    .charge-box {
        background-color: #F0FFF4;
        border-left: 5px solid #38A169;
        padding: 15px;
        border-radius: 8px;
        color: #2F855A;
        margin-bottom: 10px;
    }
    
    h4 { color: #555; }
    </style>""",
    unsafe_allow_html=True,
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Hero Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <section class="hero">
      <h1>ğŸ¤± æ˜Ÿéš›åª½åª½èƒ½é‡é¿é›·æŒ‡å—</h1>
      <p>In Lak'echï¼å°ˆå±¬åª½åª½çš„æ¯æ—¥ç”Ÿå­˜æ³•å‰‡ï¼ŒæŒæ¡çœåŠ›èˆ‡å……é›»çš„é—œéµã€‚</p>
    </section>
    """,
    unsafe_allow_html=True,
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Load Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    kin_start   = pd.read_csv(os.path.join(DATA_DIR, "kin_start_year.csv"), index_col="å¹´ä»½")["èµ·å§‹KIN"].to_dict()
    month_accum = pd.read_csv(os.path.join(DATA_DIR, "month_day_accum.csv"),   index_col="æœˆä»½")["ç´¯ç©å¤©æ•¸"].to_dict()
    kin_basic   = pd.read_csv(os.path.join(DATA_DIR, "kin_basic_info.csv"))
except Exception as e:
    st.error(f"âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š{e}")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Date Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
col_date, col_empty = st.columns([1, 2])
with col_date:
    st.subheader("ğŸ“… ä»Šå¤©æ˜¯å“ªä¸€å¤©ï¼Ÿ")
    selected_date = st.date_input("é¸æ“‡æ—¥æœŸ", datetime.now())

year = selected_date.year
month = selected_date.month
day = selected_date.day

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ KIN & Tone Calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
start_kin = kin_start.get(year)
if start_kin is None:
    st.error("âš ï¸ è³‡æ–™åº«ä¸­ç„¡æ­¤å¹´ä»½çš„èµ·å§‹ KINï¼Œç„¡æ³•è¨ˆç®—ã€‚")
    st.stop()

raw = start_kin + month_accum.get(month,0) + day
mod = raw % 260
kin = 260 if mod==0 else mod

tone_number = kin % 13
if tone_number == 0:
    tone_number = 13

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é¡¯ç¤ºåŸºæœ¬è³‡è¨Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
subset = kin_basic[kin_basic["KIN"]==kin]
if subset.empty:
    st.error(f"â“ æ‰¾ä¸åˆ° KIN {kin} è³‡æ–™")
    st.stop()
info = subset.iloc[0]
totem = info["åœ–é¨°"]

# Get Data
totem_guide = mom_totem_guide.get(totem, {})
tone_guide  = mom_tone_guide.get(tone_number, {})

st.divider()
st.markdown(f"### ğŸŒ¸ {year}/{month}/{day} åª½åª½èƒ½é‡æ°£è±¡ï¼šKIN {kin} {totem} (èª¿æ€§ {tone_number})")

col_img, col_info = st.columns([1, 4])
with col_img:
    img_file = os.path.join(IMG_DIR, f"{totem}.png")
    if os.path.exists(img_file):
        st.image(Image.open(img_file), use_container_width=True)

with col_info:
    if totem_guide:
        st.info(f"**ä»Šæ—¥ä¸»é¡Œï¼š{totem_guide['theme']}**")
        st.caption("è«‹å°ç…§ä¸‹æ–¹çš„æ“ä½œå®ˆå‰‡ï¼Œå®‰ç„¶åº¦éä»Šå¤©ã€‚")
    else:
        st.warning("ç›®å‰å°šç„¡æ­¤åœ–é¨°å°æ‡‰è³‡æ–™")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é¿é›·æŒ‡å—ä¸»å€å¡Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.divider()

col1, col2 = st.columns(2)

# å·¦æ¬„ï¼šç”Ÿå­˜æ³•å‰‡ (åœ–é¨°)
with col1:
    st.markdown("#### ğŸŒ æ¯æ—¥ç”Ÿå­˜æ³•å‰‡ (Survival Rules)")
    st.caption("ç”±ä»Šæ—¥çš„å¤ªé™½åœ–é¨°æ±ºå®š")
    
    if totem_guide:
        with st.container(border=True):
            # å¿Œ (Avoid)
            st.markdown(
                f"""
                <div class="avoid-box">
                ğŸ›‘ <strong>å¿Œ (STOP)ï¼š</strong><br>
                {totem_guide['avoid']}
                </div>
                """, 
                unsafe_allow_html=True
            )
            
            # å®œ (Charge)
            st.markdown(
                f"""
                <div class="charge-box">
                ğŸ”‹ <strong>å®œ (CHARGE)ï¼š</strong><br>
                {totem_guide['charge']}
                </div>
                """, 
                unsafe_allow_html=True
            )

# å³æ¬„ï¼šæ•™é¤Šèª¿ç¯€é–¥ (èª¿æ€§)
with col2:
    st.markdown("#### ğŸµ æ•™é¤Šèª¿ç¯€é–¥ (Parenting Valve)")
    st.caption("ç”±ä»Šæ—¥çš„éŠ€æ²³èª¿æ€§æ±ºå®šæ•™é¤Šç¯€å¥")
    
    if tone_guide:
        with st.container(border=True):
            st.markdown(f"**ğŸšï¸ èª¿æ€§ {tone_number}ï¼š{tone_guide['name']}**")
            
            st.markdown(f"**ğŸ›‘ é¿é›·ï¼š** {tone_guide['avoid']}")
            st.markdown(f"**ğŸ”‹ å……é›»ï¼š** {tone_guide['charge']}")
            
            st.info("ğŸ’¡ **å°æ’‡æ­¥**ï¼šé †è‘—é€™å€‹æµå‹•ï¼Œå¸¶å­©å­æœƒæ¯”è¼ƒçœåŠ›å–”ï¼")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åª½åª½åŠ æ²¹ç«™ (Summary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.divider()
st.subheader("ğŸ’ª çµ¦åª½åª½çš„èƒ½é‡å°èª")

summary_text = f"""
è¦ªæ„›çš„ï¼Œä»Šå¤©æ˜¯ **{totem}** çš„æ—¥å­ã€‚
å¦‚æœæ„Ÿè¦ºå¿«çˆ†ç‚¸äº†ï¼Œè«‹è¨˜å¾—é¿é–‹ã€Œ{totem_guide.get('avoid', '').split('ã€')[0]}ã€ã€‚
è©¦è‘—ã€Œ{totem_guide.get('charge', '').split('ã€‚')[0]}ã€ï¼Œé€™å°±æ˜¯å¦³ä»Šå¤©çš„å……é›»ç«™ã€‚
"""
st.success(summary_text)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å›ºå®š Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div style="margin-bottom: 80px;"></div>
    <footer class="footer">
      <p>Happy Mom, Happy Life | æ˜Ÿéš›åª½åª½èƒ½é‡é¿é›·æŒ‡å—</p>
      <a href="https://www.facebook.com/soulclean1413/" target="_blank">ğŸ‘‰ åŠ å…¥ç²‰å°ˆ</a>
    </footer>
    """,
    unsafe_allow_html=True
)
